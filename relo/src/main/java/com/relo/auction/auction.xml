<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.relo.mybatis.auction.AuctionDao">
<resultMap id="productMap" type="Product" autoMapping="true">
	<id property="pNum" column="p_num"/>
<!--  	<result property="pEndDate" column="p_end_date"/> -->
	<association property="stock" javaType="Stock" autoMapping="true">
		<result property="sName" column="s_name"/>
	</association>
	
	<collection property="a" ofType="Auction" autoMapping="true">
		<id property="aNum" column="a_num" /> 
		<result property="id" column="id"/>
		<result property="aPrice" column="a_price"/>
	</collection>
</resultMap>

<resultMap id="ordersMap" type="Product" autoMapping="true">
	<id property="pNum" column="p_num"/>
	<association property="stock" javaType="Stock" autoMapping="true">
		<result property="id" column="id"/>
	</association>
	<association property="od" javaType="ODelivery" autoMapping="true">
	</association>
	<collection property="a" ofType="Auction" autoMapping="true">
		<result property="id" column="buy_id"/>
		<result property="aPrice" column="a_price"/>
	</collection>
</resultMap>

<!-- 낙찰 상품 목록 관리자에게 출력 -->
<select id="selectByPStatus" resultMap="productMap">
select p.p_num, a.a_num, a.id, a.a_price, s.s_name "stock.s_name", p.p_end_date
from auction a, product p, stock s
where p.p_status = 6
and a.a_price = (
select max(a_price) 
from auction 
where p_num = p.p_num)
and p.s_num = s.s_num
order by p.p_end_date desc
</select>

<!-- 낙찰 상품 목록 페이징버전 -->
<select id="selectPageByPStatus" resultMap="productMap" parameterType="map">
select * from (
    select rownum rn, a.* 
    from (
        select p.p_num, a.a_num, a.id, a.a_price, s.s_name "stock.s_name", p.p_end_date
        from auction a, product p, stock s
        where p.p_status = 6
        and a.a_price = (
        select max(a_price) 
        from auction 
        where p_num = p.p_num)
        and p.s_num = s.s_num
        order by p.p_end_date desc
    ) 
a) 
where rn between #{start} and #{end}
</select>



<!-- 구매확정 상품 목록 관리자에게 출력 (관리자 확인용, 구매확정되면 자동 정산되는 걸로ㅇㅇ)-->
<select id="selectByDStatus" resultMap="ordersMap">
select p.p_num, s.id "stock.id", s.s_name "stock.s_name", a.id as buy_id, od.d_complete_day, a.a_price
from stock s, product p, auction a, orders o, order_delivery od
where od.d_status=3
and s.s_num=p.s_num
and p.p_num=a.p_num
and a.a_num=o.a_num
and o.o_num=od.o_num
order by od.d_complete_day desc
</select>

<!-- 구매확정 상품 목록 페이징 버전 -->
<select id="selectPageByDStatus" resultMap="ordersMap" parameterType="map">
select * from (
    select rownum rn, a.* 
    from (
        select p.p_num, s.id "stock.id", s.s_name "stock.s_name", a.id as buy_id, od.d_complete_day, a.a_price
        from stock s, product p, auction a, orders o, order_delivery od
        where od.d_status=3
        and s.s_num=p.s_num
        and p.p_num=a.p_num
        and a.a_num=o.a_num
        and o.o_num=od.o_num
        order by od.d_complete_day desc
    ) 
a) 
where rn between #{start} and #{end}
</select>

<!-- 가격 입력 후 입찰하기 누르면 insert문 -->
<insert id="insertAuction" parameterType="map">
insert into auction values(auction_seq.nextval,#{id}, #{pNum}, #{aPrice})
</insert>

</mapper>

